name: Full QA Suite

permissions:
  contents: read

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
  merge_group:
    types: [checks_requested]
  push:
    branches: [main]
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to check out (branch, tag, or SHA)"
        required: false
        type: string

concurrency:
  group: full-qa-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  evaluate-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decide.outputs.should_run }}
      reason: ${{ steps.decide.outputs.reason }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect risky paths
        id: risky
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            risky:
              - "middleware.ts"
              - "app/auth/**"
              - "lib/supabase/**"
              - "supabase/migrations/**"
              - "lib/fetch-penny-data.ts"
              - "lib/penny-list-query.ts"
              - "app/api/**"
              - "next.config.js"
              - "package.json"
              - "package-lock.json"
              - "playwright.config.ts"
              - ".github/workflows/**"
              - "components/store-map.tsx"
              - "app/**/layout.tsx"
              - "app/globals.css"

      - name: Decide whether to run full QA
        id: decide
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          BASE_REF: ${{ github.base_ref }}
          LABEL_NAME: ${{ github.event.label.name }}
          RISKY_CHANGED: ${{ steps.risky.outputs.risky }}
        run: |
          should_run=false
          reason="none"

          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            should_run=true
            reason="manual workflow_dispatch"
          elif [[ "$EVENT_NAME" == "schedule" ]]; then
            should_run=true
            reason="nightly schedule"
          elif [[ "$EVENT_NAME" == "merge_group" ]]; then
            should_run=true
            reason="merge group validation"
          elif [[ "$EVENT_NAME" == "pull_request" && "$BASE_REF" == "main" ]]; then
            should_run=true
            reason="pull request targets main"
          elif [[ "$EVENT_NAME" == "pull_request" && "$EVENT_ACTION" == "labeled" && "$LABEL_NAME" == "run-full-e2e" ]]; then
            should_run=true
            reason="run-full-e2e label"
          elif [[ "$RISKY_CHANGED" == "true" ]]; then
            should_run=true
            reason="risky paths changed"
          fi

          echo "should_run=$should_run" >> "$GITHUB_OUTPUT"
          echo "reason=$reason" >> "$GITHUB_OUTPUT"
          echo "Decision: should_run=$should_run ($reason)"

  fast-gate:
    needs: evaluate-trigger
    if: needs.evaluate-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.sha }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install Ruff
        run: pip install ruff==0.7.4

      - name: Ruff format check
        run: ruff format --check .

      - name: Ruff lint
        run: ruff check .

      - name: Run FAST lane
        env:
          SUPABASE_SERVICE_ROLE_KEY: test
          USE_FIXTURE_FALLBACK: "1"
        run: npm run verify:fast

  full-e2e:
    needs: [evaluate-trigger, fast-gate]
    if: needs.evaluate-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard_index: [1, 2]
        shard_total: [2]
    env:
      PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.sha }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run full e2e shard ${{ matrix.shard_index }}/${{ matrix.shard_total }}
        env:
          NEXT_DIST_DIR: .next-playwright
          PLAYWRIGHT: "1"
          NEXT_PUBLIC_EZOIC_ENABLED: "false"
          NEXT_PUBLIC_ANALYTICS_ENABLED: "false"
          USE_FIXTURE_FALLBACK: "1"
          SUPABASE_SERVICE_ROLE_KEY: test
        run: |
          npm run build
          npx playwright test --workers=1 --shard=${{ matrix.shard_index }}/${{ matrix.shard_total }}

      - name: Upload full e2e artifacts (shard ${{ matrix.shard_index }}/${{ matrix.shard_total }})
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: full-e2e-shard-${{ matrix.shard_index }}-of-${{ matrix.shard_total }}
          path: reports/playwright/
          retention-days: 14

  extended-ui-checks:
    needs: [evaluate-trigger, fast-gate]
    if: needs.evaluate-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.sha }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build e2e server bundle (.next-playwright)
        env:
          NEXT_DIST_DIR: .next-playwright
          PLAYWRIGHT: "1"
          NEXT_PUBLIC_ANALYTICS_ENABLED: "false"
          USE_FIXTURE_FALLBACK: "1"
          SUPABASE_SERVICE_ROLE_KEY: test
        run: npm run build

      - name: Start server for extended checks
        env:
          PORT: 3001
          NEXT_DIST_DIR: .next-playwright
          PLAYWRIGHT: "1"
          NEXT_PUBLIC_ANALYTICS_ENABLED: "false"
          USE_FIXTURE_FALLBACK: "1"
        run: |
          npm run start -- --hostname 0.0.0.0 --port $PORT >/tmp/next.log 2>&1 &
          server_up=0
          for i in {1..30}; do
            if curl -fsS http://localhost:$PORT >/dev/null; then
              echo "Server is up"
              server_up=1
              break
            fi
            sleep 2
          done
          if [ $server_up -ne 1 ]; then
            echo "Server failed to start"
            tail -n 50 /tmp/next.log || true
            exit 1
          fi
          echo "Server log tail:"
          tail -n 20 /tmp/next.log

      - name: Run contrast check
        env:
          BASE_URL: http://localhost:3001
        run: npm run check-contrast

      - name: Run accessibility check (axe)
        run: npm run check-axe

      - name: Upload extended check reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: full-qa-reports
          path: reports/
          retention-days: 14
