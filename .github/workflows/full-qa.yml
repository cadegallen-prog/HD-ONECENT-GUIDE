name: Full QA Suite

permissions:
  contents: read

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to check out (branch, tag, or SHA)"
        required: false
        type: string

  # Trigger when 'full-qa' label is added to a PR
  pull_request:
    types: [labeled]

  # Auto-trigger on risky file changes to main
  push:
    branches: [main]
    paths:
      # Auth & security
      - "middleware.ts"
      - "app/auth/**"
      - "lib/supabase/**"

      # Database
      - "supabase/migrations/**"
      - "lib/fetch-penny-data.ts"
      - "lib/penny-list-query.ts"

      # API routes
      - "app/api/**"

      # Infrastructure
      - "next.config.js"
      - "package.json"
      - "package-lock.json"
      - "playwright.config.ts"
      - ".github/workflows/**"

      # Fragile components (per CLAUDE.md)
      - "components/store-map.tsx"
      - "app/**/layout.tsx"
      - "app/globals.css"

jobs:
  # Gate: Only run full QA if triggered correctly
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        run: |
          # Run if: workflow_dispatch OR full-qa label OR push to main with risky paths
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Triggered by: manual dispatch"
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "Triggered by: push to main with risky file changes"
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.action }}" == "labeled" && "${{ github.event.label.name }}" == "full-qa" ]]; then
            echo "Triggered by: full-qa label"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "Trigger condition not met, skipping"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  full-qa:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install Ruff
        run: pip install ruff==0.7.4

      - name: Ruff format check
        run: ruff format --check .

      - name: Ruff lint
        run: ruff check .

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run fast QA first (lint + unit tests + build)
        env:
          # Unit tests exercise the submit-find route, which requires this env var to be present.
          # A dummy value is sufficient because tests stub the service role client.
          SUPABASE_SERVICE_ROLE_KEY: test
          # CI should not render third-party ad placeholders/scripts.
          NEXT_PUBLIC_EZOIC_ENABLED: "false"
          # CI does not have Supabase public credentials; for the build step, force the
          # server-side Supabase reads to fall back to the committed fixture so dynamic SKU
          # pages render (and SEO JSON-LD tests don't hit 404).
          USE_FIXTURE_FALLBACK: "1"
        run: npm run qa:fast

      - name: Build e2e server bundle (.next-playwright)
        env:
          NEXT_DIST_DIR: .next-playwright
          PLAYWRIGHT: "1"
          NEXT_PUBLIC_EZOIC_ENABLED: "false"
          NEXT_PUBLIC_ANALYTICS_ENABLED: "false"
          USE_FIXTURE_FALLBACK: "1"
          SUPABASE_SERVICE_ROLE_KEY: test
        run: npm run build

      - name: Start server for e2e tests
        env:
          PORT: 3001
          NEXT_DIST_DIR: .next-playwright
          PLAYWRIGHT: "1"
          NEXT_PUBLIC_EZOIC_ENABLED: "false"
          NEXT_PUBLIC_ANALYTICS_ENABLED: "false"
          USE_FIXTURE_FALLBACK: "1"
        run: |
          npm run start -- --hostname 0.0.0.0 --port $PORT >/tmp/next.log 2>&1 &
          server_up=0
          for i in {1..30}; do
            if curl -fsS http://localhost:$PORT >/dev/null; then
              echo "Server is up"
              server_up=1
              break
            fi
            sleep 2
          done
          if [ $server_up -ne 1 ]; then
            echo "Server failed to start"
            tail -n 50 /tmp/next.log || true
            exit 1
          fi
          echo "Server log tail:"
          tail -n 20 /tmp/next.log

      - name: Run e2e tests
        env:
          PLAYWRIGHT: "1"
          NEXT_PUBLIC_EZOIC_ENABLED: "false"
          NEXT_PUBLIC_ANALYTICS_ENABLED: "false"
          PLAYWRIGHT_BASE_URL: http://localhost:3001
        run: npx playwright test --workers=1

      - name: Run contrast check
        env:
          BASE_URL: http://localhost:3001
        run: npm run check-contrast

      - name: Run accessibility check (axe)
        run: npm run check-axe

      - name: Upload reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: full-qa-reports
          path: reports/
          retention-days: 14
